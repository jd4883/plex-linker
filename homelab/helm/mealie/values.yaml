# Mealie — recipe manager (recipes, meal planning, shopping lists). bjw-s app-template.
# Auth: use OIDC at the ingress (nginx + oauth2-proxy or nginx auth) so the app is not exposed without login. See README.
# See README for setup and OIDC configuration.

mealie:
  global:
    fullnameOverride: mealie
  defaultPodOptions:
    securityContext:
      runAsNonRoot: true
      runAsUser: 911
      runAsGroup: 911
      fsGroup: 911
      fsGroupChangePolicy: "OnRootMismatch"
  controllers:
    main:
      enabled: true
      type: deployment
      replicas: 1
      containers:
        main:
          image:
            repository: ghcr.io/mealie-recipes/mealie
            tag: v1.4.0
            pullPolicy: IfNotPresent
          env:
            PUID: "911"
            PGID: "911"
            TZ: America/Los_Angeles
            # Disable public signup; use OIDC at ingress or create initial user via app.
            ALLOW_SIGNUP: "false"
            # Set to your public URL so links and OAuth callbacks work (e.g. https://mealie.expectedbehaviors.com)
            BASE_URL: "https://mealie.expectedbehaviors.com"
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /api/app/about
                  port: 9000
                initialDelaySeconds: 30
                periodSeconds: 15
                timeoutSeconds: 5
                failureThreshold: 3
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /api/app/about
                  port: 9000
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 3
                failureThreshold: 3
            startup:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /api/app/about
                  port: 9000
                initialDelaySeconds: 10
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 30
          resources:
            requests:
              cpu: 50m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 1Gi
  service:
    main:
      enabled: true
      controller: main
      primary: true
      ports:
        http:
          enabled: true
          primary: true
          port: 9000
          protocol: HTTP
  ingress:
    main:
      enabled: true
      annotations:
        external-dns.alpha.kubernetes.io/target: expectedbehaviors.com
        # Enable OIDC/auth at ingress so Mealie is not publicly reachable without login.
        # Option A: nginx global auth (oauth2-proxy) — uncomment and set to "true" if using oauth2-proxy in front:
        # nginx.ingress.kubernetes.io/enable-global-auth: "true"
        # Option B: nginx auth-url (e.g. oauth2-proxy auth endpoint) — see README for auth setup.
      hosts:
        - host: mealie.expectedbehaviors.com
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - mealie.expectedbehaviors.com
          secretName: expectedbehaviors.com-tls
  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      storageClass: ""
      size: 10Gi
      globalMounts:
        - path: /app/data
          readOnly: false
