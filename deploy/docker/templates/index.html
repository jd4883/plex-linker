<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Plex Linker — Link Rules</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 1rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.4rem 0.6rem; text-align: left; }
    th { background: #eee; }
    form { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: flex-end; margin: 1rem 0; }
    input, button { padding: 0.4rem 0.6rem; }
    button.danger { background: #c00; color: #fff; border: none; cursor: pointer; }
    .msg { margin: 0.5rem 0; color: green; }
    .err { color: red; }
  </style>
</head>
<body>
  <h1>Plex Linker — Link Rules</h1>
  <p>Map movies (Radarr) to show specials (Sonarr). Add rules below; the link job runs on a schedule.</p>
  <form id="addForm">
    <input name="movie_title" placeholder="Movie title" required size="20">
    <input name="tmdb_id" type="number" placeholder="TMDB ID" required min="1" size="8">
    <input name="show_name" placeholder="Show name (Sonarr)" required size="20">
    <input name="episode" type="number" placeholder="Episode" min="0" size="4">
    <input name="season" placeholder="Season (e.g. 00)" size="4">
    <button type="submit">Add rule</button>
  </form>
  <div id="msg" class="msg"></div>
  <div id="err" class="err"></div>
  <table>
    <thead><tr><th>Movie</th><th>TMDB ID</th><th>Show</th><th>Episode</th><th>Season</th><th></th></tr></thead>
    <tbody id="rules"></tbody>
  </table>
  <script>
    const api = (path, opts = {}) => fetch(path, { ...opts, headers: { "Content-Type": "application/json", ...opts.headers } });
    function err(e) { document.getElementById("err").textContent = e; document.getElementById("msg").textContent = ""; }
    function msg(m) { document.getElementById("msg").textContent = m; document.getElementById("err").textContent = ""; }
    function load() {
      api("/api/rules").then(r => {
        if (!r.ok) { err("API error"); return r.json().catch(() => ({})); }
        return r.json();
      }).then(data => {
        if (!Array.isArray(data)) return;
        const tbody = document.getElementById("rules");
        tbody.innerHTML = data.map(r =>
          `<tr><td>${esc(r.movie_title)}</td><td>${r.tmdb_id}</td><td>${esc(r.show_name)}</td><td>${r.episode ?? ""}</td><td>${r.season ?? ""}</td><td><button class="danger" onclick="del(${r.id})">Delete</button></td></tr>`
        ).join("");
      }).catch(() => err("Failed to load rules"));
    }
    function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }
    function del(id) {
      api("/api/rules/" + id, { method: "DELETE" }).then(r => { if (r.ok) { msg("Deleted"); load(); } else err("Delete failed"); });
    }
    document.getElementById("addForm").onsubmit = (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = { movie_title: fd.get("movie_title"), tmdb_id: parseInt(fd.get("tmdb_id"), 10), show_name: fd.get("show_name") };
      if (fd.get("episode")) body.episode = parseInt(fd.get("episode"), 10);
      if (fd.get("season")) body.season = fd.get("season");
      api("/api/rules", { method: "POST", body: JSON.stringify(body) })
        .then(r => { if (r.ok) { msg("Rule added"); e.target.reset(); load(); } else r.json().then(j => err(j.detail || "Failed")); })
        .catch(() => err("Request failed"));
    };
    load();
  </script>
</body>
</html>
